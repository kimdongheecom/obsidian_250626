#### 실행순서
1. 백엔드 git clone 해서 다운받기
2. docker compose up --build -d 명령어 하기


3. 서비스 디스커버리 실행하기 위해 main.py에서 아래 이미지 부분을 수정하기 위해 아래와 같은 이미지를 첨부하고, 다음과 같이 커서에게 질문하였음
	- **커서 질문,   @main.py 여기에서 서비스디스커버리가 잘못되어서 이처럼 잘못된 코드로 진행되었어. gateway의 메인 라우터는 /e이고, financeservice는 /fin이어서 이 둘이 결합해서 /e/fin이 되도록 하고 싶어. 그런데 이 부분은 login_router, prefix="/e"처럼 login_router를 /login 으로 하지않고 /e로 해서 문제가 돼. 올바른 서비스디스커버리로 작동하도록 수정해주고, 아래 코드를 참고해서 작성해줘. 그리고 정적으로 구현하게 해줘.**
![[Pasted image 20250424164947.png]]



financeservice에 있는 메인라우터에서 @fin_router.py 연결하는 코드를 작성해줘. 이게 내가 원하는 서비스 디스커버리야.



```
from typing import Any, Dict

from fastapi import APIRouter, FastAPI, Request

from fastapi.middleware.cors import CORSMiddleware

from fastapi.responses import JSONResponse

from contextlib import asynccontextmanager

import httpx

import os

from dotenv import load_dotenv

from contextlib import asynccontextmanager

  

# .env 파일 로드

load_dotenv()

  

# ✅ FastAPI 앱 생성

app = FastAPI(

    title="Gateway API",

    description="Gateway API for jinmini.com",

    version="0.1.0",

)

gateway_router = APIRouter(prefix="/e")

  

# ✅ CORS 설정

app.add_middleware(

    CORSMiddleware,

    allow_origins=["*"],

    allow_credentials=True,

    allow_methods=["*"],

    allow_headers=["*"],

)

  

# 환경 변수에서 서비스 URL 가져오기

FINANCE_SERVICE_URL = os.getenv("FINANCE_SERVICE_URL")

ESG_SERVICE_URL = os.getenv("ESG_SERVICE_URL")

STOCK_SERVICE_URL = os.getenv("STOCK_SERVICE_URL")

  

# ✅ 애플리케이션 시작 시 `init_db()` 실행

@asynccontextmanager

async def lifespan(app: FastAPI):

    print("🚀🚀��🚀 FastAPI 앱이 시작됩니다.")

    print(f"✅ FINANCE_SERVICE_URL: {FINANCE_SERVICE_URL}")

    print(f"✅ ESG_SERVICE_URL: {ESG_SERVICE_URL}")

    print(f"✅ STOCK_SERVICE_URL: {STOCK_SERVICE_URL}")

    yield  # 애플리케이션이 실행되는 동안 유지

    print("🛑 FastAPI 앱이 종료됩니다.")

  

app.include_router(gateway_router)

  

# Finance 서비스 프록시 라우터 - HTTP 메서드별로 분리

@app.get("/e/fin/{path:path}")

async def proxy_finance_get(path: str, request: Request):

    print(f"GET 요청을 처리합니다: /e/fin/{path}")

    async with httpx.AsyncClient() as client:

        response = await client.request(

            method="GET",

            url=f"{FINANCE_SERVICE_URL}/fin/{path}",

            headers=request.headers.raw

        )

        return response.json()

  

@app.post("/e/fin/{path:path}")

async def proxy_finance_post(path: str, request: Request):

    print(f"POST 요청을 처리합니다: /e/fin/{path}")

    body = await request.body()

    print(f"요청 본문: {body}")

    async with httpx.AsyncClient() as client:

        response = await client.request(

            method="POST",

            url=f"{FINANCE_SERVICE_URL}/fin/{path}",

            headers=request.headers.raw,

            data=body

        )

        return response.json()

  

@app.put("/e/fin/{path:path}")

async def proxy_finance_put(path: str, request: Request):

    print(f"PUT 요청을 처리합니다: /e/fin/{path}")

    async with httpx.AsyncClient() as client:

        response = await client.request(

            method="PUT",

            url=f"{FINANCE_SERVICE_URL}/fin/{path}",

            headers=request.headers.raw,

            data=await request.body()

        )

        return response.json()

  

@app.delete("/e/fin/{path:path}")

async def proxy_finance_delete(path: str, request: Request):

    print(f"DELETE 요청을 처리합니다: /e/fin/{path}")

    async with httpx.AsyncClient() as client:

        response = await client.request(

            method="DELETE",

            url=f"{FINANCE_SERVICE_URL}/fin/{path}",

            headers=request.headers.raw

        )

        return response.json()

  

# ESG 서비스 프록시 라우팅

@app.api_route("/e/esg/{path:path}", methods=["GET", "POST", "PUT", "DELETE"])

async def proxy_esg(path: str, request: Request):

    async with httpx.AsyncClient() as client:

        response = await client.request(

            method=request.method,

            url=f"{ESG_SERVICE_URL}/esg/{path}",

            headers=request.headers.raw,

            data=await request.body()

        )

        return response.json()

  

@app.api_route("/e/stock/{path:path}", methods=["GET", "POST", "PUT", "DELETE"])

async def proxy_stock(path: str, request: Request):

    async with httpx.AsyncClient() as client:

        response = await client.request(

            method=request.method,

            url=f"{STOCK_SERVICE_URL}/stock/{path}",

            headers=request.headers.raw,

            data=await request.body()

        )

        return response.json()

  

# ✅ 서버 실행

if __name__ == "__main__":

    import uvicorn

    port = int(os.getenv("PORT", 8080))

    uvicorn.run("app.main:app", host="0.0.0.0", port=port, reload=True)
```